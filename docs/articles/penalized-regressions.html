<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitting penalized regressions • bigstatsr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Fitting penalized regressions">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bigstatsr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.2.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Manual</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://privefl.github.io/R-presentation/bigstatsr.html">Introduction to package bigstatsr</a>
    </li>
    <li>
      <a href="https://privefl.github.io/bigsnpr/articles/exo.html">Exercise</a>
    </li>
    <li>
      <a href="../articles/penalized-regressions.html">Fitting penalized regressions</a>
    </li>
    <li>
      <a href="../articles/bigstatsr-and-bigmemory.html">Packages bigstatsr and bigmemory</a>
    </li>
    <li>
      <a href="../articles/operations-with-scaling.html">Operations with scaling</a>
    </li>
    <li>
      <a href="../articles/read-FBM-from-file.html">Read a FBM from a text file</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://privefl.github.io/about.html">
    <span class="fa fa-user"></span>
     
    About
  </a>
</li>
<li>
  <a href="https://github.com/privefl/bigstatsr">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Fitting penalized regressions</h1>
                        <h4 class="author">Florian Privé</h4>
            
            <h4 class="date">May 22, 2019</h4>
      
      
      <div class="hidden name"><code>penalized-regressions.Rmd</code></div>

    </div>

    
    
<p>In R package {bigstatsr}, you can fit efficient penalized (linear and logistic) regressions using functions <code><a href="../reference/big_spLinReg.html">big_spLinReg()</a></code> and <code><a href="../reference/big_spLogReg.html">big_spLogReg()</a></code>. Similar implementation of Cox regression is an area of future development.</p>
<p>You might want to look at the corresponding paper and cite it:</p>
<p>Privé, Florian, Hugues Aschard, and Michael GB Blum. “Efficient implementation of penalized regression for genetic risk prediction.” Genetics (2019). [<a href="https://doi.org/10.1534/genetics.119.302019">Open access</a>]</p>
<div id="data" class="section level2">
<h2 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h2>
<p>To illustrate how to use <code><a href="../reference/big_spLinReg.html">big_spLinReg()</a></code> and <code><a href="../reference/big_spLogReg.html">big_spLogReg()</a></code>, let us use some simulated data:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(bigstatsr)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="co"># simulating some data</span></a>
<a class="sourceLine" id="cb1-5" title="5">N &lt;-<span class="st"> </span><span class="dv">530</span></a>
<a class="sourceLine" id="cb1-6" title="6">M &lt;-<span class="st"> </span><span class="dv">730</span></a>
<a class="sourceLine" id="cb1-7" title="7">X &lt;-<span class="st"> </span><span class="kw"><a href="../reference/FBM-class.html">FBM</a></span>(N, M, <span class="dt">init =</span> <span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(N <span class="op">*</span><span class="st"> </span>M, <span class="dt">sd =</span> <span class="dv">5</span>))</a>
<a class="sourceLine" id="cb1-8" title="8">y &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(X[, <span class="dv">1</span><span class="op">:</span><span class="dv">100</span>]) <span class="op">+</span><span class="st"> </span><span class="dv">20</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(N)</a>
<a class="sourceLine" id="cb1-9" title="9"></a>
<a class="sourceLine" id="cb1-10" title="10">ind.train &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(X), <span class="dv">400</span>))</a>
<a class="sourceLine" id="cb1-11" title="11">ind.test &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/bigparallelr/man/seq-dim.html">rows_along</a></span>(X), ind.train)</a></code></pre></div>
</div>
<div id="cross-model-selection-and-averaging-cmsa" class="section level2">
<h2 class="hasAnchor">
<a href="#cross-model-selection-and-averaging-cmsa" class="anchor"></a>Cross-Model Selection and Averaging (CMSA)</h2>
<p>Functions <code><a href="../reference/big_spLinReg.html">big_spLinReg()</a></code> and <code><a href="../reference/big_spLogReg.html">big_spLogReg()</a></code> automatically perform a procedure similar to cross-validation to choose hyper-parameters <span class="math inline">\(\lambda\)</span> and <span class="math inline">\(\alpha\)</span> of the elastic net regularization:</p>
<div class="figure" style="text-align: center">
<img src="https://raw.githubusercontent.com/privefl/paper2-PRS/master/figures/simple-CMSA.png" alt='Illustration of one turn of the Cross-Model Selection and Averaging (CMSA) procedure. First, this procedure separates the outer training set (blue *and* red) in K folds (e.g. 10 folds). Secondly, in turn, each fold is considered as an inner validation set (red) and the other (K - 1) folds form an inner training set (blue). A "regularization path" of models is trained on the inner training set and the corresponding predictions (scores) for the inner validation set are computed. The model that minimizes the loss on the inner validation set is selected.  Finally, the K resulting models are averaged. We also use this procedure to derive an early stopping criterion so that the algorithm does not need to evaluate the whole regularization paths, making this procedure much faster than standard cross-validation.' width="70%"><p class="caption">
Illustration of one turn of the Cross-Model Selection and Averaging (CMSA) procedure. First, this procedure separates the outer training set (blue <em>and</em> red) in K folds (e.g. 10 folds). Secondly, in turn, each fold is considered as an inner validation set (red) and the other (K - 1) folds form an inner training set (blue). A “regularization path” of models is trained on the inner training set and the corresponding predictions (scores) for the inner validation set are computed. The model that minimizes the loss on the inner validation set is selected. Finally, the K resulting models are averaged. We also use this procedure to derive an early stopping criterion so that the algorithm does not need to evaluate the whole regularization paths, making this procedure much faster than standard cross-validation.
</p>
</div>
<div id="sequences-of-hyper-parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#sequences-of-hyper-parameters" class="anchor"></a>Sequences of hyper-parameters</h3>
<ul>
<li><p>The first (maximum) value of the lambda sequence (<span class="math inline">\(\lambda_{max}\)</span>) is computed automatically and corresponds to enough regularization to have no variable entering the model. Then, a sequence of <code>nlambda</code> (200 by default) values is used, equally spaces on a log-scale between <span class="math inline">\(\lambda_{max}\)</span> and <span class="math inline">\(\lambda_{max}\)</span> * <code>lambda.min</code>.</p></li>
<li><p>A sequence of <span class="math inline">\(\alpha\)</span> can be defined by the user using <code>alphas</code> (default is <code>1</code>). We recommend to use a grid on a log-scale (e.g. <code>10^(-(0:4))</code>).</p></li>
</ul>
</div>
<div id="stopping-criterion-for-regularization-path" class="section level3">
<h3 class="hasAnchor">
<a href="#stopping-criterion-for-regularization-path" class="anchor"></a>Stopping criterion for regularization path</h3>
<p>There are three main reasons for which regularization paths can end:</p>
<ul>
<li><p>the current model include too many non-zero variables (<code>dfmax</code> equals <code>50e3</code> by default, you can use <code>Inf</code>)</p></li>
<li><p>the early stopping criterion is reached, which means that models are getting worse for the inner validation set; you can control this using <code>nlam.min</code> (the minimal number of <span class="math inline">\(\lambda\)</span> values to try before stopping) and <code>n.abort</code> (the number of <span class="math inline">\(\lambda\)</span> values for which the model is getting worse)</p></li>
<li><p>the <code>nlambda</code> <span class="math inline">\(\lambda\)</span> values have been used; you might want to reduce <code>lambda.min</code> to go further down the path</p></li>
</ul>
<p>It is possible to fit the <code>K</code> folds for each value of <code>alphas</code> in parallel using parameter <code>ncores</code>.</p>
<p>You <em>should</em> check why regularization paths stop. For this, you can use both methods <code><a href="https://rdrr.io/r/graphics/plot.html">plot()</a></code> and <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code>. Let us make an example below.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">mod &lt;-<span class="st"> </span><span class="kw"><a href="../reference/big_spLinReg.html">big_spLinReg</a></span>(X, y[ind.train], <span class="dt">ind.train =</span> ind.train, <span class="dt">K =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(mod)</a></code></pre></div>
<pre><code>## # A tibble: 1 x 7
##   alpha validation_loss intercept beta        nb_var message   all_conv
##   &lt;dbl&gt;           &lt;dbl&gt;     &lt;dbl&gt; &lt;list&gt;       &lt;int&gt; &lt;list&gt;    &lt;lgl&gt;   
## 1     1           1794.     -2.23 &lt;dbl [730]&gt;    369 &lt;chr [4]&gt; TRUE</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(mod)<span class="op">$</span>message</a></code></pre></div>
<pre><code>## [[1]]
## [1] "No more improvement" "No more improvement" "No more improvement"
## [4] "No more improvement"</code></pre>
<p>Here, <code>"No more improvement"</code> means that the early stopping criterion has been reached. We can see the validation loss getting worse at some point:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(mod)</a></code></pre></div>
<p><img src="penalized-regressions_files/figure-html/unnamed-chunk-4-1.png" width="70%" style="display: block; margin: auto;"></p>
<p>For small datasets, you might want to reduce the number of folds (<code>K</code> = 10 bu default). For large datasets, you might want to decrease <code>n.abort</code> (i.e. stop the regularization path quickly) as the path is usually much more smooth and fitting is more and more demanding as we advance along the regularization path (because more and more variables are used in the model).</p>
<p>Use <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> to use the model for data in the test set:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">pred &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(mod, X, ind.test)</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(pred, y[ind.test], <span class="dt">pch =</span> <span class="dv">20</span>); <span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">"red"</span>)</a></code></pre></div>
<p><img src="penalized-regressions_files/figure-html/unnamed-chunk-5-1.png" width="70%" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="other-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#other-parameters" class="anchor"></a>Other parameters</h2>
<ul>
<li><p>You can add covariates as a standard R matrix using parameter <code>covar.train</code>; it will fit the model as if <code>X[ind.train, ]</code> and <code>covar.train</code> were <code>cbind</code>ed.</p></li>
<li><p>You can add an offset to your model using <code>base.train</code> (on the linear scale, do not provide probabilities!).</p></li>
<li><p>You can apply some multiplicative penalization factors (<code>pf.X</code> and <code>pf.covar</code>) to penalize variables differently (possibly no penalization for <em>some</em> variables using <code>0</code>).</p></li>
<li><p>Functions <code><a href="../reference/big_spLinReg.html">big_spLinReg()</a></code> and <code><a href="../reference/big_spLogReg.html">big_spLogReg()</a></code> are not deterministic because folds are chosen randomly. One way that should ensure reproducibility is to define your own folds using parameter <code>ind.sets</code> (using e.g. <code><a href="https://rdrr.io/r/base/sample.html">sample(rep_len(1:K, length(ind.train)))</a></code>).</p></li>
</ul>
</div>
<div id="time-and-memory-requirements-from-the-paper" class="section level2">
<h2 class="hasAnchor">
<a href="#time-and-memory-requirements-from-the-paper" class="anchor"></a>Time and memory requirements (from the paper)</h2>
<p>The computation time of our PLR implementation mainly depends on the sample size and the number of candidate variables (variables that are included in the gradient descent). Indeed, the algorithm is composed of <strong>two steps</strong>: first, for each variable, the algorithm computes an univariate statistic that is used to decide if the variable is included in the model (for each value of <span class="math inline">\(\lambda\)</span>). This first step is very fast (if data can be quickly read from disk). Then, the algorithm iterates over a regularization path of decreasing values of <span class="math inline">\(\lambda\)</span>, which progressively enables variables to enter the model (see first figure). In the second step, the number of variables increases and computations stop when an early stopping criterion is reached (when prediction is getting worse on the corresponding validation set, see first figure).</p>
<p>For outcomes that require lots of variables to predict, such as predicting height and when using huge datasets such as the UK Biobank, the algorithm might iterate over &gt;100,000 variables, which is computationally demanding. On the contrary, for outcomes that require only a few variables to predict, such as autoimmune diseases, the number of variables included in the model is much smaller so that fitting is very fast (only 13 min for 150K women of the UK Biobank for breast cancer).</p>
<p><strong>Memory requirements are tightly linked to computation time.</strong> Indeed, variables are accessed in memory thanks to memory-mapping when they are used. When there is not enough memory left, the operating system (OS) frees some memory for new incoming variables. Yet, if too many variables are used in the gradient descent, the OS would regularly swap memory between disk and RAM, severely slowing down computations.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#data">Data</a></li>
      <li><a href="#cross-model-selection-and-averaging-cmsa">Cross-Model Selection and Averaging (CMSA)</a></li>
      <li><a href="#other-parameters">Other parameters</a></li>
      <li><a href="#time-and-memory-requirements-from-the-paper">Time and memory requirements (from the paper)</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Florian Privé.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
